# .github/workflows/powerapps-reusable.yml
name: PowerApps Reusable Workflow

on:
  workflow_call:
    inputs:
      pac_path:
        required: false
        type: string
      solutions:
        required: true
        type: string
      env_file:
        required: true
        type: string

jobs:
  powerapps-workflow:
    runs-on: self-hosted

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Load environment variables
        run: |
          set -a
          source ${{ inputs.env_file }}
          set +a

      - name: Ensure .NET 8 SDK
        run: |
          if ! dotnet --list-sdks | grep -q "^8"; then
            echo "Installing .NET 8 SDK..."
            wget https://dotnet.microsoft.com/download/dotnet/scripts/v1/dotnet-install.sh -O dotnet-install.sh
            chmod +x dotnet-install.sh
            ./dotnet-install.sh --version 8.0.19 --install-dir $HOME/.dotnet
            export PATH=$HOME/.dotnet:$PATH
          fi
          dotnet --list-sdks

      - name: Install PAC CLI
        run: |
          PAC_PATH=${{ inputs.pac_path:-$HOME/.pac}}
          mkdir -p $PAC_PATH
          dotnet tool install Microsoft.PowerApps.CLI.Tool --version 1.43.6 --tool-path $PAC_PATH
          echo "PAC installed to $PAC_PATH"
          echo "PAC_PATH=$PAC_PATH" >> $GITHUB_ENV
          export PATH=$PAC_PATH:$PATH

      - name: Verify PAC CLI
        run: $PAC_PATH/pac tool list

      - name: Export & Unpack Solutions
        run: |
          mkdir -p solutions
          SOLUTIONS=$(echo '${{ inputs.solutions }}' | jq -r '.[]')
          for sol in $SOLUTIONS; do
            echo "Processing solution: $sol"
            $PAC_PATH/pac auth create --url "$CRM_URL" --clientId "$CLIENT_ID" --clientSecret "$CLIENT_SECRET" --tenant "$TENANT_ID"
            $PAC_PATH/pac solution export --name "$sol" --path "solutions/$sol.zip" --overwrite
            $PAC_PATH/pac solution unpack --zip-file "solutions/$sol.zip" --folder "solutions/$sol" --allow-delete
          done

      - name: Commit & Push Changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add solutions/*
          git diff --cached --quiet || git commit -m "Updated Power Platform solutions"
          git push
