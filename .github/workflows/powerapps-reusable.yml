name: Power Platform Reusable Workflow
on:
  workflow_call:
    inputs:
      pp_environment:
        required: true
        type: string
      solutions:
        required: true
        type: string
    secrets:
      azure_client_id:
        required: true
      azure_client_secret:
        required: true
      azure_tenant_id:
        required: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Setup .NET SDK 8 and 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
      
      - name: Configure .NET environment variables
        shell: bash
        run: |
          dotnet --version
          dotnet --list-sdks
          
          # Ensure DOTNET_ROOT is set (setup-dotnet should handle this, but let's be explicit)
          echo "DOTNET_ROOT=$DOTNET_ROOT" >> $GITHUB_ENV
          echo "âœ“ .NET SDKs installed and configured"
      
      - name: Install PAC CLI
        run: |
          PAC_PATH="$HOME/.pac"
          mkdir -p "$PAC_PATH"
          
          if ! command -v pac >/dev/null 2>&1; then
            echo "Installing PAC CLI..."
            dotnet tool install Microsoft.PowerApps.CLI.Tool --version 1.43.6 --tool-path "$PAC_PATH"
          fi
          
          echo "$PAC_PATH" >> $GITHUB_PATH
      
      - name: Verify PAC CLI installation
        run: |
          export PATH="$HOME/.pac:$PATH"
          pac
      
      - name: Authenticate PAC CLI
        run: |
          export PATH="$HOME/.pac:$PATH"
          pac auth create \
            --name "ci-auth" \
            --environment "${{ inputs.pp_environment }}" \
            --tenant "${{ secrets.azure_tenant_id }}" \
            --applicationId "${{ secrets.azure_client_id }}" \
            --clientSecret "${{ secrets.azure_client_secret }}" \
            --cloud "Public"
      
      - name: Export & Unpack Solutions
        run: |
          export PATH="$HOME/.pac:$PATH"
          mkdir -p solutions
          
          echo '${{ inputs.solutions }}' | jq -r '.[]' | while read sol; do
            echo "Processing solution: $sol"
            pac solution export --name "$sol" --path "solutions/$sol.zip" --overwrite
            pac solution unpack --zip-file "solutions/$sol.zip" --folder "solutions/$sol" --allow-delete
          done
      
      - name: Commit & Push Changes if any
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          if [ -n "$(git status --porcelain solutions)" ]; then
            git add solutions/*
            git commit -m "Updated Power Platform solutions"
            git push
          else
            echo "echo "No changes detected in solutions folder. Skipping commit."
          fi
